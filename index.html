<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品管家 Pro | 奶茶粉圓版</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- 引入粉圓體 (使用 jsDelivr CDN) --- */
        @font-face {
            font-family: 'jf-openhuninn';
            src: url('https://cdn.jsdelivr.net/gh/justfont/open-huninn-font@HEAD/font/jf-openhuninn-2.0.woff2') format('woff2');
            font-display: swap;
        }

        :root {
            /* --- 奶茶風配色 (高對比修正版) --- */
            
            /* 背景：保持溫潤的燕麥奶色 */
            --bg-color: #f3eee8; 
            
            /* 光影系統 */
            --neu-light: #ffffff; 
            --neu-shadow: #d1c6bc; /*稍微加深陰影，讓立體感更明顯但乾淨*/
            
            /* 漸層主色 (焦糖奶茶) */
            --primary-gradient: linear-gradient(135deg, #d4a574, #b0855b);
            --primary-text: #fff;
            
            /* --- 文字顏色 (解決看不清的問題) --- */
            /* 主要文字：濃縮咖啡色 (極深棕)，確保清晰 */
            --text-main: #3b2e25; 
            /* 次要文字：可可色，對比度足夠 */
            --text-sub: #635147;
            
            /* 點綴色 */
            --accent-color: #9c6f44; /* 太妃糖色 */
            --danger: #cc5a5a; /* 豆沙紅 */
            
            --radius: 24px;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            /* 全域套用粉圓體 */
            font-family: 'jf-openhuninn', "PingFang TC", "Microsoft JhengHei", sans-serif; 
        }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            font-size: 16px; /* 稍微放大基底字體 */
        }

        /* --- 新擬態共用樣式 --- */
        .neu-flat {
            background: var(--bg-color);
            box-shadow: 6px 6px 12px var(--neu-shadow), 
                       -6px -6px 12px var(--neu-light);
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,0.4);
        }

        .neu-pressed {
            background: var(--bg-color);
            box-shadow: inset 4px 4px 8px var(--neu-shadow), 
                       inset -4px -4px 8px var(--neu-light);
            border-radius: 14px;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .neu-pressed:focus-within {
            border-color: var(--accent-color);
            background: #fdfcfb; /* 輸入時背景微微變亮，增加易讀性 */
        }

        /* --- Header --- */
        header {
            padding: 15px 24px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 50;
            background: var(--bg-color);
            box-shadow: 0 4px 20px rgba(59, 46, 37, 0.05);
        }
        
        h1 { 
            margin: 0; font-size: 1.5rem; font-weight: 400; /* 粉圓體本身就很粗，weight 設 400 即可 */
            color: var(--text-main);
            letter-spacing: 1px;
        }
        
        /* 圓形按鈕 */
        .btn-circle {
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer; color: var(--text-main);
            background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--neu-shadow), -5px -5px 10px var(--neu-light);
            transition: 0.2s;
        }
        .btn-circle:active {
            box-shadow: inset 3px 3px 6px var(--neu-shadow), inset -3px -3px 6px var(--neu-light);
        }
        .icon { width: 24px; height: 24px; fill: var(--text-main); }

        /* --- 控制面板 --- */
        .control-panel {
            padding: 20px 24px;
            display: flex; gap: 15px; flex-wrap: wrap;
            flex-shrink: 0;
        }

        .input-wrapper { flex: 1; min-width: 150px; position: relative; }
        
        .neu-input, .neu-select {
            width: 100%; padding: 14px 18px;
            font-size: 1rem; color: var(--text-main);
            outline: none; appearance: none;
            background: transparent;
        }
        .neu-input::placeholder { color: #9c8c82; } /* 讓 placeholder 清楚一點 */
        
        .select-arrow {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            pointer-events: none; color: var(--text-main); font-size: 0.8rem;
        }

        /* --- 主內容區 --- */
        .main-content {
            flex: 1; overflow-y: auto; padding: 10px 24px 80px 24px;
        }

        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .view-title { font-size: 1.1rem; color: var(--text-main); }

        .product-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px;
        }

        /* --- 產品卡片 --- */
        .card {
            padding: 20px; display: flex; gap: 18px;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-3px); }

        .card-img-box {
            width: 90px; height: 90px; flex-shrink: 0;
            border-radius: 18px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--neu-shadow), inset -3px -3px 6px var(--neu-light);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .no-img { font-size: 0.8rem; color: var(--text-sub); }

        .card-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* 標題加深 */
        .card-title { font-size: 1.2rem; margin-bottom: 4px; color: var(--text-main); line-height: 1.3; }
        
        .card-tag { 
            font-size: 0.85rem; color: var(--accent-color); 
            display: inline-block; margin-bottom: 8px;
        }
        
        .card-details { font-size: 0.95rem; color: var(--text-sub); line-height: 1.6; }
        
        .card-footer { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 12px; border-top: 2px dashed rgba(99, 81, 71, 0.1); padding-top: 8px;
        }
        .card-price { font-size: 1.3rem; color: var(--accent-color); }
        
        .card-actions { display: flex; gap: 10px; }
        
        .barcode-strip { height: 28px; margin-top: 6px; opacity: 0.9; mix-blend-mode: multiply; }
        .barcode-strip img { height: 100%; width: auto; }

        /* --- 按鈕樣式 --- */
        .btn-grad {
            border: none; border-radius: 24px; padding: 12px 24px;
            font-size: 1rem; cursor: pointer;
            background: var(--primary-gradient);
            color: var(--primary-text);
            box-shadow: 4px 4px 10px rgba(176, 133, 91, 0.4), 
                       -4px -4px 10px var(--neu-light);
            transition: 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-grad:active {
            transform: scale(0.98);
            box-shadow: inset 3px 3px 6px rgba(0,0,0,0.2);
        }

        .btn-text {
            background: transparent; border: none; cursor: pointer;
            color: var(--text-sub); font-size: 0.95rem;
            padding: 6px 12px; border-radius: 12px; transition: 0.2s;
        }
        .btn-text:hover { background: rgba(255,255,255,0.6); color: var(--text-main); }
        .btn-del { color: var(--danger); }
        .btn-del:hover { background: rgba(204, 90, 90, 0.1); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(59, 46, 37, 0.5); backdrop-filter: blur(6px);
            z-index: 100; display: none; opacity: 0; transition: opacity 0.3s;
            justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        
        .modal-card {
            background: var(--bg-color);
            width: 90%; max-width: 500px;
            border-radius: 32px;
            padding: 0;
            display: flex; flex-direction: column; max-height: 85vh;
            box-shadow: 20px 20px 60px var(--neu-shadow), -20px -20px 60px var(--neu-light);
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.show .modal-card { transform: scale(1); }

        .modal-header {
            padding: 24px; border-bottom: 2px solid rgba(99, 81, 71, 0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 1.3rem; color: var(--text-main); }
        .modal-body { padding: 24px; overflow-y: auto; }

        /* 設定按鈕 */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .settings-btn {
            background: var(--bg-color);
            border-radius: 24px; padding: 20px;
            text-align: center; cursor: pointer; color: var(--text-main);
            box-shadow: 6px 6px 12px var(--neu-shadow), -6px -6px 12px var(--neu-light);
            transition: 0.2s; border: 1px solid transparent;
            display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1rem;
        }
        .settings-btn:active { box-shadow: inset 4px 4px 8px var(--neu-shadow), inset -4px -4px 8px var(--neu-light); }
        .settings-btn svg { width: 32px; height: 32px; fill: var(--accent-color); }

        /* 分類管理 */
        .cat-item { margin-bottom: 16px; }
        .cat-header {
            padding: 14px 18px; background: rgba(255,255,255,0.6);
            border-radius: 16px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--text-main);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.02);
        }
        .cat-body { height: 0; overflow: hidden; transition: height 0.3s ease; padding: 0 10px; }
        .cat-body.open { height: auto; padding-top: 15px; padding-bottom: 15px;}
        
        .sub-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; border-bottom: 1px dashed rgba(99, 81, 71, 0.15); font-size: 1rem;
        }

        /* 圖片上傳 */
        .img-upload-box {
            width: 100%; height: 120px;
            border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); cursor: pointer; overflow: hidden;
            background: var(--bg-color);
            box-shadow: inset 4px 4px 8px var(--neu-shadow), inset -4px -4px 8px var(--neu-light);
            border: 2px solid transparent; transition: 0.2s;
        }
        .img-upload-box:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .img-upload-box img { width: 100%; height: 100%; object-fit: contain; }

        .form-row { display: flex; gap: 20px; margin-bottom: 24px; }
        .form-col { flex: 1; }
        label { display: block; font-size: 1rem; color: var(--text-main); margin-bottom: 10px; }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; gap: 20px; }
            .control-panel { flex-direction: column; }
        }
        #pdf-hidden { position: absolute; top: -9999px; }
    </style>
</head>
<body>

    <header>
        <h1>產品管家 Pro</h1>
        <button class="btn-circle" onclick="openModal('settingsModal')" title="設定">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </button>
    </header>

    <div class="control-panel">
        <div class="input-wrapper">
            <select id="mainCatSelect" class="neu-select neu-pressed" onchange="filterChange()">
                </select>
            <span class="select-arrow">▼</span>
        </div>
        <div class="input-wrapper">
            <select id="subCatSelect" class="neu-select neu-pressed" onchange="renderProducts()">
                </select>
            <span class="select-arrow">▼</span>
        </div>
        <div class="input-wrapper" style="flex: 2;">
            <input type="text" id="searchInput" class="neu-input neu-pressed" placeholder="搜尋產品名稱..." oninput="renderProducts()">
        </div>
    </div>

    <div class="main-content">
        <div class="section-header">
            <span id="viewTitle" class="view-title">全部產品</span>
            <button class="btn-grad" onclick="openProductModal()">
                <span>＋</span> 新增商品
            </button>
        </div>
        <div class="product-grid" id="productList">
            </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title">系統設定</span>
                <button class="btn-text" onclick="closeModal('settingsModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="settings-grid">
                    <div class="settings-btn" onclick="document.getElementById('fileInput').click()">
                        <svg viewBox="0 0 24 24"><path d="M19,9h-4V3H9v6H5l7,7L19,9z M5,18v2h14v-2H5z"/></svg>
                        <span>匯入 JSON</span>
                        <input type="file" id="fileInput" hidden accept=".json" onchange="importData(this)">
                    </div>
                    <div class="settings-btn" onclick="exportData()">
                        <svg viewBox="0 0 24 24"><path d="M19,9h-4V3H9v6H5l7,7L19,9z M5,18v2h14v-2H5z" transform="rotate(180 12 12)"/></svg>
                        <span>匯出 JSON</span>
                    </div>
                </div>
                <div style="margin-bottom:20px">
                     <div class="settings-btn" style="flex-direction:row; justify-content:center;" onclick="generatePDF()">
                        <svg viewBox="0 0 24 24"><path d="M19,8H5c-1.66,0-3,1.34-3,3v6h4v4h12v-4h4v-6C22,9.34,20.66,8,19,8z M16,19H8v-5h8V19z M19,12c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1S19.55,12,19,12z"/></svg>
                        <span>下載 / 列印 PDF</span>
                    </div>
                </div>

                <hr style="border:0; border-top:2px dashed rgba(99, 81, 71, 0.1); margin:20px 0;">
                
                <h4 style="margin:0 0 15px 0; color:var(--text-main);">分類管理</h4>
                <div class="form-row" style="gap:10px;">
                    <input type="text" id="newMainCat" class="neu-input neu-pressed" placeholder="新分類名稱...">
                    <button class="btn-grad" style="padding:10px 18px; border-radius:14px;" onclick="addCategory()">新增</button>
                </div>
                <div id="categoryManageList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title" id="prodModalTitle">產品資料</span>
                <button class="btn-text" onclick="closeModal('productModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                
                <div class="form-row">
                    <div class="form-col">
                        <label>主分類</label>
                        <select id="pCat" class="neu-select neu-pressed" onchange="updateSubSelectInModal()"></select>
                    </div>
                    <div class="form-col">
                        <label>子分類</label>
                        <select id="pSub" class="neu-select neu-pressed"></select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>產品名稱</label>
                        <input type="text" id="pName" class="neu-input neu-pressed" placeholder="輸入名稱">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>外重</label>
                        <input type="number" id="pOutW" class="neu-input neu-pressed">
                    </div>
                    <div class="form-col">
                        <label>內重</label>
                        <input type="number" id="pInW" class="neu-input neu-pressed">
                    </div>
                    <div class="form-col">
                        <label>單位</label>
                        <select id="pUnit" class="neu-select neu-pressed">
                            <option>g</option><option>kg</option><option>ml</option><option>入</option><option>盒</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>價格 ($)</label>
                        <input type="number" id="pPrice" class="neu-input neu-pressed">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>材積 (cm) - L x W x H</label>
                        <div style="display:flex; gap:12px;">
                            <input type="number" id="sizeL" class="neu-input neu-pressed" placeholder="L" oninput="calcVol()">
                            <input type="number" id="sizeW" class="neu-input neu-pressed" placeholder="W" oninput="calcVol()">
                            <input type="number" id="sizeH" class="neu-input neu-pressed" placeholder="H" oninput="calcVol()">
                        </div>
                        <div style="font-size:1rem; color:var(--accent-color); margin-top:10px;">
                            總體積: <span id="volDisplay" style="font-weight:bold;">0</span> cm³
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>產品圖片</label>
                        <input type="file" id="upImg" hidden accept="image/*" onchange="preview(this, 'prevImg')">
                        <div class="img-upload-box" id="prevImg" onclick="document.getElementById('upImg').click()">
                            <span>點擊上傳</span>
                        </div>
                    </div>
                    <div class="form-col">
                        <label>條碼圖片</label>
                        <input type="file" id="upCode" hidden accept="image/*" onchange="preview(this, 'prevCode')">
                        <div class="img-upload-box" id="prevCode" onclick="document.getElementById('upCode').click()">
                            <span>點擊上傳</span>
                        </div>
                    </div>
                </div>

                <button class="btn-grad" style="width:100%; justify-content:center; margin-top:10px;" onclick="saveProduct()">儲存變更</button>
            </div>
        </div>
    </div>

    <div id="pdf-hidden">
        <h2 style="text-align:center; padding-top:20px; color:#3b2e25; font-family:'jf-openhuninn';">產品清單</h2>
        <p style="text-align:right; padding-right:20px; color:#635147;" id="pdfDate"></p>
        <table border="1" cellspacing="0" cellpadding="8" width="100%" style="border-collapse:collapse; font-size:12px; margin-top:10px; border-color:#d1c6bc;">
            <thead><tr style="background:#e8dfd8; color:#3b2e25;"><th>名稱</th><th>分類</th><th>規格</th><th>價格</th><th>尺寸 (L x W x H)</th><th>條碼</th></tr></thead>
            <tbody id="pdfTbody" style="color:#3b2e25;"></tbody>
        </table>
    </div>

<script>
    // --- Data ---
    const DEFAULT_DATA = { categories: [
        { id: 'c1', name: '精選茶葉', subcategories: [
            { id: 's1', name: '烏龍茶', products: [
                { id: 'p1', name: '凍頂烏龍', outerWeight: 320, contentWeight: 300, unit: 'g', price: 1000, sizeL:10, sizeW:10, sizeH:20, volume:2000, img:'', barcode:'' }
            ]}
        ]}
    ]};
    let appData = JSON.parse(localStorage.getItem('neuMilkTeaV2Data')) || DEFAULT_DATA;

    function init() {
        renderSelects();
        renderProducts();
    }

    // --- Core Logic ---
    function renderProducts() {
        const list = document.getElementById('productList');
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        
        const selMain = document.getElementById('mainCatSelect').value;
        const selSub = document.getElementById('subCatSelect').value;

        let html = '';
        let hasData = false;
        
        const isSearching = searchTerm.length > 0;

        if(isSearching) {
            document.getElementById('viewTitle').innerText = `搜尋結果: "${searchTerm}"`;
        } else {
            if(selMain === 'all') document.getElementById('viewTitle').innerText = '全部產品';
            else {
                const c = appData.categories.find(x=>x.id===selMain);
                document.getElementById('viewTitle').innerText = c ? c.name : '未知';
            }
        }

        appData.categories.forEach(cat => {
            if(!isSearching && selMain !== 'all' && cat.id !== selMain) return;

            cat.subcategories.forEach(sub => {
                if(!isSearching && selMain !== 'all' && selSub !== 'all' && sub.id !== selSub) return;

                sub.products.forEach(p => {
                    if(isSearching && !p.name.toLowerCase().includes(searchTerm)) return;

                    hasData = true;
                    const imgHtml = p.img ? `<img src="${p.img}" class="card-img">` : `<span class="no-img">無圖</span>`;
                    const codeHtml = p.barcode ? `<div class="barcode-strip"><img src="${p.barcode}"></div>` : '';

                    html += `
                    <div class="neu-flat card">
                        <div class="card-img-box">${imgHtml}</div>
                        <div class="card-info">
                            <div>
                                <div class="card-title">${p.name}</div>
                                <div class="card-tag">${cat.name} / ${sub.name}</div>
                            </div>
                            <div class="card-details">
                                規格: ${p.contentWeight}${p.unit} (含包: ${p.outerWeight}${p.unit})<br>
                                尺寸: ${p.sizeL||0} x ${p.sizeW||0} x ${p.sizeH||0} cm
                            </div>
                            ${codeHtml}
                            <div class="card-footer">
                                <div class="card-price">$${p.price}</div>
                                <div class="card-actions">
                                    <button class="btn-text" onclick="editProd('${p.id}','${cat.id}','${sub.id}')">編輯</button>
                                    <button class="btn-text btn-del" onclick="delProd('${p.id}','${cat.id}','${sub.id}')">刪除</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
            });
        });

        if(!hasData) list.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sub);">無產品資料</div>`;
        else list.innerHTML = html;
    }

    // --- Selects ---
    function renderSelects() {
        const main = document.getElementById('mainCatSelect');
        const curr = main.value;
        let html = `<option value="all">所有分類</option>`;
        appData.categories.forEach(c => html += `<option value="${c.id}">${c.name}</option>`);
        main.innerHTML = html;
        main.value = curr || 'all';
        renderSubSelect();
    }
    function renderSubSelect() {
        const mainId = document.getElementById('mainCatSelect').value;
        const sub = document.getElementById('subCatSelect');
        let html = `<option value="all">所有子項</option>`;
        if(mainId !== 'all') {
            const cat = appData.categories.find(c => c.id === mainId);
            if(cat) cat.subcategories.forEach(s => html += `<option value="${s.id}">${s.name}</option>`);
        }
        sub.innerHTML = html;
    }
    function filterChange() {
        renderSubSelect();
        document.getElementById('searchInput').value = '';
        renderProducts();
    }

    // --- Modal Logic ---
    function openModal(id) { document.getElementById(id).classList.add('show'); if(id==='settingsModal') renderManageList(); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    // --- Category Management ---
    function renderManageList() {
        const div = document.getElementById('categoryManageList');
        div.innerHTML = appData.categories.map(c => `
            <div class="cat-item neu-flat" style="border:none;">
                <div class="cat-header" onclick="this.nextElementSibling.classList.toggle('open')">
                    ${c.name}
                    <div><button class="btn-text btn-del" onclick="delCat('${c.id}', event)">刪除</button> ▼</div>
                </div>
                <div class="cat-body">
                    ${c.subcategories.map(s => `
                        <div class="sub-item">
                            └ ${s.name}
                            <button class="btn-text btn-del" onclick="delSub('${c.id}','${s.id}')">刪除</button>
                        </div>
                    `).join('')}
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input type="text" id="newSub_${c.id}" class="neu-input neu-pressed" placeholder="新增子分類...">
                        <button class="btn-grad" style="padding:8px 15px;" onclick="addSub('${c.id}')">＋</button>
                    </div>
                </div>
            </div>
        `).join('');
    }
    function addCategory() {
        const name = document.getElementById('newMainCat').value;
        if(name) { appData.categories.push({id:'c'+Date.now(),name,subcategories:[]}); document.getElementById('newMainCat').value=''; saveAll(); }
    }
    function addSub(cid) {
        const input = document.getElementById(`newSub_${cid}`);
        if(input.value) { appData.categories.find(c=>c.id===cid).subcategories.push({id:'s'+Date.now(),name:input.value,products:[]}); saveAll(); }
    }
    function delCat(id,e) { e.stopPropagation(); if(confirm('刪除?')) { appData.categories=appData.categories.filter(c=>c.id!==id); saveAll(); } }
    function delSub(cid,sid) { if(confirm('刪除?')) { const c=appData.categories.find(x=>x.id===cid); c.subcategories=c.subcategories.filter(s=>s.id!==sid); saveAll(); } }
    function saveAll() { localStorage.setItem('neuMilkTeaV2Data', JSON.stringify(appData)); renderManageList(); renderSelects(); renderProducts(); }

    // --- Product CRUD ---
    function openProductModal() {
        document.getElementById('pId').value=''; document.getElementById('pName').value='';
        document.getElementById('pOutW').value=''; document.getElementById('pInW').value='';
        document.getElementById('pPrice').value='';
        document.getElementById('sizeL').value=''; document.getElementById('sizeW').value=''; document.getElementById('sizeH').value='';
        document.getElementById('volDisplay').innerText='0';
        resetPreview('prevImg'); resetPreview('prevCode');

        const currMain = document.getElementById('mainCatSelect').value;
        const currSub = document.getElementById('subCatSelect').value;
        const catSel = document.getElementById('pCat');

        catSel.innerHTML = '<option value="">請選擇</option>' + appData.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        
        if(currMain !== 'all') {
            catSel.value = currMain;
            updateSubSelectInModal();
            if(currSub !== 'all') {
                document.getElementById('pSub').value = currSub;
            }
        } else {
            document.getElementById('pSub').innerHTML = '';
        }

        openModal('productModal');
    }

    function updateSubSelectInModal() {
        const cid = document.getElementById('pCat').value;
        const subSel = document.getElementById('pSub');
        if(!cid) { subSel.innerHTML=''; return; }
        const cat = appData.categories.find(c=>c.id===cid);
        subSel.innerHTML = cat.subcategories.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    }

    function editProd(pid, cid, sid) {
        openProductModal();
        const cat = appData.categories.find(c=>c.id===cid);
        const sub = cat.subcategories.find(s=>s.id===sid);
        const p = sub.products.find(x=>x.id===pid);

        document.getElementById('pId').value=pid;
        document.getElementById('pCat').value=cid; updateSubSelectInModal();
        document.getElementById('pSub').value=sid;
        document.getElementById('pName').value=p.name;
        document.getElementById('pOutW').value=p.outerWeight; document.getElementById('pInW').value=p.contentWeight;
        document.getElementById('pUnit').value=p.unit; document.getElementById('pPrice').value=p.price;
        document.getElementById('sizeL').value=p.sizeL; document.getElementById('sizeW').value=p.sizeW; document.getElementById('sizeH').value=p.sizeH;
        document.getElementById('volDisplay').innerText=p.volume||0;
        if(p.img) setPreview('prevImg', p.img);
        if(p.barcode) setPreview('prevCode', p.barcode);
    }

    function saveProduct() {
        const cid = document.getElementById('pCat').value;
        const sid = document.getElementById('pSub').value;
        const name = document.getElementById('pName').value;
        if(!cid||!sid||!name) return alert('分類與名稱必填');
        
        const pid = document.getElementById('pId').value;
        const newData = {
            id: pid || 'p'+Date.now(), name,
            outerWeight: document.getElementById('pOutW').value,
            contentWeight: document.getElementById('pInW').value,
            unit: document.getElementById('pUnit').value,
            price: document.getElementById('pPrice').value,
            sizeL: document.getElementById('sizeL').value,
            sizeW: document.getElementById('sizeW').value,
            sizeH: document.getElementById('sizeH').value,
            volume: document.getElementById('volDisplay').innerText,
            img: document.getElementById('prevImg').dataset.val||'',
            barcode: document.getElementById('prevCode').dataset.val||''
        };

        if(pid) {
            appData.categories.forEach(c=>c.subcategories.forEach(s=>s.products=s.products.filter(x=>x.id!==pid)));
        }
        appData.categories.find(c=>c.id===cid).subcategories.find(s=>s.id===sid).products.push(newData);
        saveAll(); closeModal('productModal');
    }

    function delProd(pid, cid, sid) {
        if(confirm('刪除？')) {
            const s = appData.categories.find(c=>c.id===cid).subcategories.find(s=>s.id===sid);
            s.products = s.products.filter(p=>p.id!==pid);
            saveAll();
        }
    }

    // --- Helpers ---
    function calcVol() {
        const l=document.getElementById('sizeL').value||0, w=document.getElementById('sizeW').value||0, h=document.getElementById('sizeH').value||0;
        document.getElementById('volDisplay').innerText = l*w*h;
    }
    function preview(ipt, id) {
        if(ipt.files[0]) {
            const r = new FileReader();
            r.onload = e => setPreview(id, e.target.result);
            r.readAsDataURL(ipt.files[0]);
        }
    }
    function setPreview(id, src) { const d=document.getElementById(id); d.innerHTML=`<img src="${src}">`; d.dataset.val=src; }
    function resetPreview(id) { const d=document.getElementById(id); d.innerHTML=`<span>點擊上傳</span>`; delete d.dataset.val; }

    function exportData() {
        const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData));
        a.download='data.json'; document.body.appendChild(a); a.click(); a.remove();
    }
    function importData(ipt) {
        if(ipt.files[0]) {
            const r=new FileReader(); r.onload=e=>{ try{appData=JSON.parse(e.target.result);saveAll();alert('匯入成功');}catch(e){alert('錯誤');} };
            r.readAsText(ipt.files[0]);
        }
    }
    async function generatePDF() {
        const tbody = document.getElementById('pdfTbody'); tbody.innerHTML='';
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
        
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        let count = 0;
        const isSearching = searchTerm.length > 0;
        const selMain = document.getElementById('mainCatSelect').value;
        const selSub = document.getElementById('subCatSelect').value;

        appData.categories.forEach(c => {
            if(!isSearching && selMain !== 'all' && c.id !== selMain) return;
            c.subcategories.forEach(s => {
                if(!isSearching && selMain !== 'all' && selSub !== 'all' && s.id !== selSub) return;
                s.products.forEach(p => {
                    if(isSearching && !p.name.toLowerCase().includes(searchTerm)) return;
                    tbody.innerHTML += `<tr><td>${p.name}</td><td>${c.name}-${s.name}</td><td>${p.contentWeight}${p.unit}</td><td>${p.price}</td><td>${p.sizeL||0}x${p.sizeW||0}x${p.sizeH||0}</td><td>${p.barcode?`<img src="${p.barcode}" height="30">`:''}</td></tr>`;
                    count++;
                });
            });
        });

        if(count===0) return alert('無內容');
        const el = document.getElementById('pdf-hidden'); el.style.top='0'; el.style.left='0'; el.style.background='#fff'; el.style.zIndex='200';
        
        try {
            const canvas = await html2canvas(el, {scale:2});
            const pdf = new window.jspdf.jsPDF();
            const w = pdf.internal.pageSize.getWidth();
            const h = (canvas.height*w)/canvas.width;
            pdf.addImage(canvas.toDataURL('image/jpeg'),'JPEG',0,0,w,h);
            pdf.save('products.pdf');
        } catch(e){alert('PDF Error');} finally {el.style.top='-9999px';}
    }

    init();
</script>
</body>
</html>
