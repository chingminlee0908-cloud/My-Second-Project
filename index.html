<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°·èŠ³èŒ¶æ¥­ç”¢å“ç¸½è¡¨ (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* åŸæœ¬çš„ CSS æ¨£å¼å®Œå…¨ä¿ç•™ï¼Œä¸éœ€è¦æ›´å‹• */
        @font-face {
            font-family: 'jf-openhuninn';
            src: url('https://cdn.jsdelivr.net/gh/justfont/open-huninn-font@HEAD/font/jf-openhuninn-2.0.woff2') format('woff2');
            font-display: swap;
        }

        :root {
            --bg-color: #f3eee8; 
            --neu-light: #ffffff; 
            --neu-shadow: #d1c6bc;
            --primary-gradient: linear-gradient(135deg, #d4a574, #b0855b);
            --primary-text: #fff;
            --text-main: #3b2e25; 
            --text-sub: #635147;
            --accent-color: #9c6f44;
            --danger: #cc5a5a;
            --info: #5a8bbd;
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'jf-openhuninn', "PingFang TC", sans-serif; -webkit-font-smoothing: antialiased; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 17px; }
        input, select, button, textarea { font-family: 'jf-openhuninn', sans-serif; }

        /* Neumorphism */
        .neu-flat { background: var(--bg-color); box-shadow: 6px 6px 12px var(--neu-shadow), -6px -6px 12px var(--neu-light); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.4); }
        .neu-pressed { background: var(--bg-color); box-shadow: inset 4px 4px 8px var(--neu-shadow), inset -4px -4px 8px var(--neu-light); border-radius: 16px; border: 1px solid transparent; transition: 0.2s; }
        .neu-pressed:focus-within { border-color: var(--accent-color); background: #fdfcfb; }

        /* Header */
        header { padding: 15px 24px; display: flex; justify-content: space-between; align-items: center; z-index: 50; background: var(--bg-color); box-shadow: 0 4px 20px rgba(59, 46, 37, 0.05); }
        h1 { margin: 0; font-size: 1.6rem; font-weight: 400; color: var(--text-main); letter-spacing: 1px; }
        .btn-circle { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; color: var(--text-main); background: var(--bg-color); box-shadow: 5px 5px 10px var(--neu-shadow), -5px -5px 10px var(--neu-light); transition: 0.2s; }
        .btn-circle:active { box-shadow: inset 3px 3px 6px var(--neu-shadow), inset -3px -3px 6px var(--neu-light); }
        .icon { width: 24px; height: 24px; fill: var(--text-main); }

        /* Controls */
        .control-panel { padding: 20px 24px; display: flex; gap: 15px; flex-wrap: wrap; flex-shrink: 0; }
        .input-wrapper { flex: 1; min-width: 150px; position: relative; }
        .neu-input, .neu-select, .neu-textarea { width: 100%; padding: 14px 20px; font-size: 1rem; color: var(--text-main); outline: none; appearance: none; background: transparent; border-radius: 20px; }
        .neu-textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
        .neu-input::placeholder { color: #9c8c82; }
        .select-arrow { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-main); font-size: 0.8rem; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 10px 24px 80px 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .view-title { font-size: 1.2rem; color: var(--text-main); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }

        /* Card */
        .card { padding: 20px; display: flex; gap: 18px; transition: transform 0.2s; border-radius: 28px; flex-direction: column; }
        .card-main-area { display: flex; gap: 18px; }
        .card-left-col { width: 90px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
        .card-img-box { width: 90px; height: 90px; border-radius: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--bg-color); box-shadow: inset 3px 3px 6px var(--neu-shadow), inset -3px -3px 6px var(--neu-light); border: 1px solid rgba(255,255,255,0.5); }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .no-img { font-size: 0.8rem; color: var(--text-sub); }
        .barcode-display { width: 100%; min-height: 25px; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 8px; padding: 2px; opacity: 0.8; mix-blend-mode: multiply; }
        .barcode-display img { max-width: 100%; height: auto; display: block; }
        .no-barcode { font-size: 0.6rem; color: #ccc; }
        .card-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 1.25rem; margin-bottom: 4px; color: var(--text-main); line-height: 1.3; font-weight: 400; }
        .card-tag { font-size: 0.9rem; color: var(--accent-color); display: inline-block; margin-bottom: 8px; }
        .card-details { font-size: 0.95rem; color: var(--text-sub); line-height: 1.6; }
        .cost-badge { display: inline-block; font-size: 0.9rem; color: var(--info); background: rgba(90, 139, 189, 0.1); padding: 2px 8px; border-radius: 8px; margin-top: 4px; font-weight: bold; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; border-top: 2px dashed rgba(99, 81, 71, 0.1); padding-top: 8px; }
        .card-price { font-size: 1.4rem; color: var(--accent-color); font-weight: 400; }
        .card-actions { display: flex; gap: 8px; }
        .card-desc-area { display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.4); border-radius: 16px; font-size: 0.95rem; color: var(--text-main); line-height: 1.6; white-space: pre-wrap; border: 1px solid rgba(255,255,255,0.6); }
        .card-desc-area.open { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Buttons */
        .btn-grad { border: none; border-radius: 30px; padding: 12px 24px; font-size: 1rem; cursor: pointer; background: var(--primary-gradient); color: var(--primary-text); box-shadow: 4px 4px 10px rgba(176, 133, 91, 0.4), -4px -4px 10px var(--neu-light); transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-grad:active { transform: scale(0.98); box-shadow: inset 3px 3px 6px rgba(0,0,0,0.2); }
        .btn-text { background: transparent; border: none; cursor: pointer; color: var(--text-sub); font-size: 0.95rem; padding: 6px 10px; border-radius: 12px; transition: 0.2s; }
        .btn-text:hover { background: rgba(255,255,255,0.6); color: var(--text-main); }
        .btn-del { color: var(--danger); }
        .btn-del:hover { background: rgba(204, 90, 90, 0.1); }
        .btn-toggle { background: var(--bg-color); box-shadow: 3px 3px 6px var(--neu-shadow), -3px -3px 6px var(--neu-light); color: var(--text-main); }
        .btn-toggle:active, .btn-toggle.active { box-shadow: inset 3px 3px 6px var(--neu-shadow), inset -3px -3px 6px var(--neu-light); color: var(--accent-color); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(59, 46, 37, 0.5); backdrop-filter: blur(6px); z-index: 100; display: none; opacity: 0; transition: opacity 0.3s; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-card { background: var(--bg-color); width: 90%; max-width: 500px; border-radius: 36px; padding: 0; display: flex; flex-direction: column; max-height: 85vh; box-shadow: 20px 20px 60px var(--neu-shadow), -20px -20px 60px var(--neu-light); transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.show .modal-card { transform: scale(1); }
        .modal-header { padding: 24px; border-bottom: 2px solid rgba(99, 81, 71, 0.05); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.4rem; color: var(--text-main); }
        .modal-body { padding: 24px; overflow-y: auto; }

        /* Settings */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .settings-btn { background: var(--bg-color); border-radius: 24px; padding: 20px; text-align: center; cursor: pointer; color: var(--text-main); box-shadow: 6px 6px 12px var(--neu-shadow), -6px -6px 12px var(--neu-light); transition: 0.2s; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1.1rem; }
        .settings-btn:active { box-shadow: inset 4px 4px 8px var(--neu-shadow), inset -4px -4px 8px var(--neu-light); }
        .settings-btn svg { width: 32px; height: 32px; fill: var(--accent-color); }

        .mode-switch-area { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; border: 1px solid rgba(255,255,255,0.8); }
        .mode-label { font-weight: bold; color: var(--text-main); }
        .mode-desc { font-size: 0.85rem; color: var(--text-sub); }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Category List */
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: rgba(255,255,255,0.6); border-radius: 18px; margin-bottom: 12px; box-shadow: 2px 2px 5px rgba(0,0,0,0.02); }
        .cat-name { font-size: 1.1rem; font-weight: bold; flex: 1; }
        .cat-actions { display: flex; gap: 8px; }

        .img-upload-box { width: 100%; height: 120px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sub); cursor: pointer; overflow: hidden; background: var(--bg-color); box-shadow: inset 4px 4px 8px var(--neu-shadow), inset -4px -4px 8px var(--neu-light); border: 2px solid transparent; transition: 0.2s; }
        .img-upload-box:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .img-upload-box img { width: 100%; height: 100%; object-fit: contain; }

        .form-row { display: flex; gap: 20px; margin-bottom: 24px; }
        .form-col { flex: 1; }
        label { display: block; font-size: 1rem; color: var(--text-main); margin-bottom: 10px; }

        @media (max-width: 600px) { .form-row { flex-direction: column; gap: 20px; } .control-panel { flex-direction: column; } }
        #pdf-hidden { position: absolute; top: -9999px; }
        
        .pwd-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 0.9rem; color: var(--text-sub); display: flex; align-items: center; gap: 5px; }
        
        /* é›²ç«¯ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        #cloudStatus { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 999; display: none; }
    </style>
</head>
<body>

    <header>
        <h1>è°·èŠ³èŒ¶æ¥­ç”¢å“ç¸½è¡¨ (Cloud)</h1>
        <button class="btn-circle" onclick="openModal('settingsModal')" title="è¨­å®š">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </button>
    </header>

    <div class="control-panel">
        <div class="input-wrapper">
            <select id="mainCatSelect" class="neu-select neu-pressed" onchange="filterChange()"></select>
            <span class="select-arrow">â–¼</span>
        </div>
        <div class="input-wrapper" style="flex: 2;">
            <input type="text" id="searchInput" class="neu-input neu-pressed" placeholder="æœå°‹ç”¢å“åç¨±..." oninput="renderProducts()">
        </div>
    </div>

    <div class="main-content">
        <div class="section-header">
            <span id="viewTitle" class="view-title">å…¨éƒ¨ç”¢å“</span>
            <button class="btn-grad" onclick="openProductModal()"><span>ï¼‹</span> æ–°å¢å•†å“</button>
        </div>
        <div class="product-grid" id="productList">
            <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-sub);">
                æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...
            </div>
        </div>
    </div>
    
    <div id="cloudStatus">è³‡æ–™åŒæ­¥ä¸­...</div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title">ç³»çµ±è¨­å®š</span>
                <button class="btn-text" onclick="closeModal('settingsModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="settings-grid">
                    <div class="settings-btn" onclick="document.getElementById('fileInput').click()">
                        <svg viewBox="0 0 24 24"><path d="M19,9h-4V3H9v6H5l7,7L19,9z M5,18v2h14v-2H5z"/></svg><span>åŒ¯å…¥ JSON</span>
                        <input type="file" id="fileInput" hidden accept=".json" onchange="importData(this)">
                    </div>
                    <div class="settings-btn" onclick="exportData()">
                        <svg viewBox="0 0 24 24"><path d="M19,9h-4V3H9v6H5l7,7L19,9z M5,18v2h14v-2H5z" transform="rotate(180 12 12)"/></svg><span>åŒ¯å‡º JSON</span>
                    </div>
                    <div class="settings-btn" onclick="generatePDF()">
                        <svg viewBox="0 0 24 24"><path d="M19,8H5c-1.66,0-3,1.34-3,3v6h4v4h12v-4h4v-6C22,9.34,20.66,8,19,8z M16,19H8v-5h8V19z M19,12c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1S19.55,12,19,12z"/></svg><span>åˆ—å° PDF</span>
                    </div>
                    <div class="settings-btn" onclick="openChangePwdModal()">
                        <svg viewBox="0 0 24 24"><path d="M12.65,10C12.86,10.65,13,11.31,13,12c0,3.87-3.13,7-7,7s-7-3.13-7-7s3.13-7,7-7c0.69,0,1.35,0.14,2,0.35V2.5 c-0.62-0.16-1.29-0.3-2-0.3a9.9,9.9,0,0,0-7,2.95A9.9,9.9,0,0,0,13,12c0,0.69-0.08,1.36-0.23,2H22v-4H12.65z M18,10v2h2v-2H18z M18,6 v2h2V6H18z M22,6h-2V2.5h-4v7.8c-0.62,0.16-1.29,0.3-2,0.3c-0.1,0-0.19-0.01-0.29-0.01V6h4v2h2V6h2V6z"/></svg><span>æ›´æ”¹é€šè¡Œç¢¼</span>
                    </div>
                </div>

                <div class="mode-switch-area">
                    <div><div class="mode-label">å…¬å¸å…§éƒ¨æ¨¡å¼</div><div class="mode-desc">é¡¯ç¤ºæˆæœ¬è³‡è¨Šèˆ‡å…§éƒ¨å‚™è¨»</div></div>
                    <label class="switch"><input type="checkbox" id="modeToggle" onchange="toggleInternalMode(this)"><span class="slider"></span></label>
                </div>

                <hr style="border:0; border-top:2px dashed rgba(99, 81, 71, 0.1); margin:20px 0;">
                
                <h4 style="margin:0 0 15px 0; color:var(--text-main);">åˆ†é¡ç®¡ç†</h4>
                <div class="form-row" style="gap:10px;">
                    <input type="text" id="newMainCat" class="neu-input neu-pressed" placeholder="æ–°åˆ†é¡åç¨±...">
                    <button class="btn-grad" style="padding:10px 18px; border-radius:14px;" onclick="addCategory()">æ–°å¢</button>
                </div>
                <div id="categoryManageList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="changePwdModal">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title">æ›´æ”¹é€šè¡Œç¢¼</span>
                <button class="btn-text" onclick="closeModal('changePwdModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-row"><div class="form-col"><label>è«‹è¼¸å…¥èˆŠå¯†ç¢¼</label><input type="password" id="oldPwdInput" class="neu-input neu-pressed"></div></div>
                <div class="form-row">
                    <div class="form-col" style="position:relative;">
                        <label>è¨­å®šæ–°å¯†ç¢¼</label>
                        <input type="password" id="newPwdInput" class="neu-input neu-pressed">
                        <label class="pwd-toggle">
                            <input type="checkbox" onchange="togglePwdVisibility(this)"> ğŸ‘ï¸ é¡¯ç¤º
                        </label>
                    </div>
                </div>
                <button class="btn-grad" style="width:100%; justify-content:center; margin-top:20px;" onclick="saveNewPassword()">ç¢ºèªæ›´æ”¹</button>
                <div style="text-align:center; margin-top:15px;">
                    <button class="btn-text btn-del" onclick="resetPassword()">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ(é‡ç½®)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-card">
            <div class="modal-header"><span class="modal-title">ç”¢å“è³‡æ–™</span><button class="btn-text" onclick="closeModal('productModal')">âœ•</button></div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <div class="form-row"><div class="form-col"><label>åˆ†é¡</label><select id="pCat" class="neu-select neu-pressed"></select></div></div>
                <div class="form-row"><div class="form-col"><label>ç”¢å“åç¨±</label><input type="text" id="pName" class="neu-input neu-pressed"></div></div>
                <div class="form-row">
                    <div class="form-col"><label>å¤–é‡</label><input type="number" id="pOutW" class="neu-input neu-pressed"></div>
                    <div class="form-col"><label>å…§é‡</label><input type="number" id="pInW" class="neu-input neu-pressed"></div>
                    <div class="form-col"><label>å–®ä½</label><select id="pUnit" class="neu-select neu-pressed"><option>g</option><option>kg</option><option>ml</option><option>å…¥</option><option>ç›’</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label>å”®åƒ¹ ($)</label><input type="number" id="pPrice" class="neu-input neu-pressed"></div>
                    <div class="form-col" id="costInputGroup" style="display:none;"><label style="color:var(--info)">æˆæœ¬ ($)</label><input type="number" id="pCost" class="neu-input neu-pressed" placeholder="å…§éƒ¨"></div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>æç© (cm) - L x W x H</label>
                        <div style="display:flex; gap:12px;">
                            <input type="number" id="sizeL" class="neu-input neu-pressed" placeholder="L" oninput="calcVol()"><input type="number" id="sizeW" class="neu-input neu-pressed" placeholder="W" oninput="calcVol()"><input type="number" id="sizeH" class="neu-input neu-pressed" placeholder="H" oninput="calcVol()">
                        </div>
                        <div style="font-size:1rem; color:var(--accent-color); margin-top:10px;">ç¸½é«”ç©: <span id="volDisplay" style="font-weight:bold;">0</span> cmÂ³</div>
                    </div>
                </div>
                <div class="form-row"><div class="form-col"><label>ç”¢å“ä»‹ç´¹ / å‚™è¨»</label><textarea id="pDesc" class="neu-textarea neu-pressed"></textarea></div></div>
                <div class="form-row">
                    <div class="form-col"><label>ç”¢å“åœ–ç‰‡</label><input type="file" id="upImg" hidden accept="image/*" onchange="preview(this, 'prevImg')"><div class="img-upload-box" id="prevImg" onclick="document.getElementById('upImg').click()"><span>ä¸Šå‚³</span></div></div>
                    <div class="form-col"><label>æ¢ç¢¼åœ–ç‰‡</label><input type="file" id="upCode" hidden accept="image/*" onchange="preview(this, 'prevCode')"><div class="img-upload-box" id="prevCode" onclick="document.getElementById('upCode').click()"><span>ä¸Šå‚³</span></div></div>
                </div>
                <button class="btn-grad" style="width:100%; justify-content:center;" onclick="saveProduct()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <div id="pdf-hidden">
        <h2 style="text-align:center; padding-top:20px; color:#3b2e25; font-family:'jf-openhuninn';">è°·èŠ³èŒ¶æ¥­ç”¢å“ç¸½è¡¨</h2>
        <p style="text-align:right; padding-right:20px; color:#635147;" id="pdfDate"></p>
        <table border="1" cellspacing="0" cellpadding="8" width="100%" style="border-collapse:collapse; font-size:12px; margin-top:10px; border-color:#d1c6bc;">
            <thead><tr id="pdfHead" style="background:#e8dfd8; color:#3b2e25;"><th>åç¨±</th><th>åˆ†é¡</th><th>è¦æ ¼</th><th>åƒ¹æ ¼</th><th>å°ºå¯¸</th><th>æ¢ç¢¼</th></tr></thead>
            <tbody id="pdfTbody" style="color:#3b2e25;"></tbody>
        </table>
    </div>

<script type="module">
    // ----------------------
    // Firebase é€£ç·šè¨­å®šå€
    // ----------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAFZfrS32tKFKEO3ZwAgv1Y2BQAj7W8K9Y",
        authDomain: "my-second-project-db.firebaseapp.com",
        projectId: "my-second-project-db",
        storageBucket: "my-second-project-db.firebasestorage.app",
        messagingSenderId: "183253772016",
        appId: "1:183253772016:web:557c0d6a857e5fda3d8435",
        measurementId: "G-1YT95SQRDF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // æˆ‘å€‘å°‡æ‰€æœ‰è³‡æ–™å­˜åœ¨ä¸€å€‹å« 'data' çš„æ–‡ä»¶è£¡ï¼Œæ”¾åœ¨ 'store' é›†åˆä¸­
    const docRef = doc(db, "store", "data");

    // ----------------------
    // æ‡‰ç”¨ç¨‹å¼é‚è¼¯
    // ----------------------
    const DEFAULT_DATA = { categories: [{ id: 'c1', name: 'ç²¾é¸èŒ¶è‘‰', products: [{ id: 'p1', name: 'å‡é ‚çƒé¾', outerWeight: 320, contentWeight: 300, unit: 'g', price: 1000, cost: 500, sizeL:10, sizeW:10, sizeH:20, volume:2000, desc:'åš´é¸é«˜å±±çƒé¾ï¼Œé¦™æ°£æ¿ƒéƒã€‚', img:'', barcode:'' }] }] };
    
    // ç¾åœ¨ appData é è¨­ç‚ºç©ºï¼Œç­‰å¾…é›²ç«¯è³‡æ–™è¼‰å…¥
    let appData = DEFAULT_DATA;
    let isInternalMode = false;
    
    // å°‡åŸæœ¬çš„ localStorage å¯†ç¢¼ä¿ç•™ (å¯†ç¢¼ä¸éœ€è¦é›²ç«¯åŒæ­¥ï¼Œæ¯å°è£ç½®è‡ªå·±è¨˜ä½ç‹€æ…‹)
    if (!localStorage.getItem('gf_internal_pwd')) {
        localStorage.setItem('gf_internal_pwd', '8888');
    }

    // 1. ç›£è½é›²ç«¯è³‡æ–™ (Realtime Sync)
    // åªè¦é›²ç«¯æœ‰è®Šå‹•ï¼Œé€™è£¡å°±æœƒè‡ªå‹•åŸ·è¡Œï¼Œæ›´æ–°ç•«é¢
    onSnapshot(docRef, (docSnap) => {
        const statusEl = document.getElementById('cloudStatus');
        if (docSnap.exists()) {
            console.log("å¾é›²ç«¯æ”¶åˆ°æ–°è³‡æ–™ï¼");
            appData = docSnap.data();
            renderSelects();
            renderProducts();
        } else {
            console.log("é›²ç«¯æ²’è³‡æ–™ï¼Œå¯«å…¥é è¨­å€¼...");
            saveToCloud(DEFAULT_DATA); // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè‡ªå‹•å¯«å…¥é è¨­å€¼
        }
    });

    // 2. å„²å­˜åˆ°é›²ç«¯ (å–ä»£åŸæœ¬çš„ saveAll)
    async function saveToCloud(data) {
        const statusEl = document.getElementById('cloudStatus');
        statusEl.style.display = 'block';
        statusEl.innerText = 'æ­£åœ¨å„²å­˜åˆ°é›²ç«¯...';
        
        try {
            await setDoc(docRef, data);
            statusEl.innerText = 'å„²å­˜æˆåŠŸï¼';
            setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
        } catch (e) {
            console.error("å„²å­˜å¤±æ•—: ", e);
            statusEl.innerText = 'å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯';
            statusEl.style.backgroundColor = '#cc5a5a';
        }
    }

    // å°‡æ ¸å¿ƒåŠŸèƒ½æ›è¼‰åˆ° windowï¼Œè®“ HTML çš„ onclick å¯ä»¥å‘¼å«
    window.toggleInternalMode = toggleInternalMode;
    window.openChangePwdModal = openChangePwdModal;
    window.togglePwdVisibility = togglePwdVisibility;
    window.saveNewPassword = saveNewPassword;
    window.resetPassword = resetPassword;
    window.filterChange = filterChange;
    window.renderProducts = renderProducts;
    window.toggleDesc = toggleDesc;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.renderManageList = renderManageList;
    window.addCategory = addCategory;
    window.renameCat = renameCat;
    window.delCat = delCat;
    window.openProductModal = openProductModal;
    window.editProd = editProd;
    window.saveProduct = saveProduct;
    window.delProd = delProd;
    window.calcVol = calcVol;
    window.preview = preview;
    window.exportData = exportData;
    window.importData = importData;
    window.generatePDF = generatePDF;


    // --- Mode Logic ---
    function toggleInternalMode(checkbox) {
        if (checkbox.checked) {
            const pwd = prompt("è«‹è¼¸å…¥å…§éƒ¨é€šè¡Œç¢¼:", "");
            const currentPwd = localStorage.getItem('gf_internal_pwd');
            if (pwd === currentPwd) {
                isInternalMode = true; alert("å·²é–‹å•Ÿå…§éƒ¨æ¨¡å¼"); renderProducts();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤"); checkbox.checked = false; isInternalMode = false;
            }
        } else {
            isInternalMode = false; renderProducts();
        }
    }

    // --- Password Management ---
    function openChangePwdModal() {
        document.getElementById('oldPwdInput').value = '';
        document.getElementById('newPwdInput').value = '';
        openModal('changePwdModal');
    }

    function togglePwdVisibility(checkbox) {
        document.getElementById('newPwdInput').type = checkbox.checked ? "text" : "password";
    }

    function saveNewPassword() {
        const oldPwd = document.getElementById('oldPwdInput').value;
        const newPwd = document.getElementById('newPwdInput').value;
        const currentPwd = localStorage.getItem('gf_internal_pwd');

        if (oldPwd !== currentPwd) { alert("èˆŠå¯†ç¢¼éŒ¯èª¤ï¼"); return; }
        if (!newPwd || newPwd.trim() === "") { alert("æ–°å¯†ç¢¼ä¸èƒ½ç‚ºç©ºï¼"); return; }

        localStorage.setItem('gf_internal_pwd', newPwd);
        alert("å¯†ç¢¼æ›´æ”¹æˆåŠŸï¼");
        closeModal('changePwdModal');
    }

    function resetPassword() {
        if(confirm("ç¢ºå®šè¦é‡ç½®å¯†ç¢¼å—ï¼Ÿ\nå¯†ç¢¼å°‡æ¢å¾©ç‚ºé è¨­å€¼ï¼š8888")) {
            localStorage.setItem('gf_internal_pwd', '8888');
            alert("å¯†ç¢¼å·²é‡ç½®ç‚º 8888");
            closeModal('changePwdModal');
        }
    }

    // --- Core Render ---
    function renderProducts() {
        const list = document.getElementById('productList');
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const selMain = document.getElementById('mainCatSelect').value;
        let html = '', hasData = false;
        const isSearching = searchTerm.length > 0;

        if(isSearching) document.getElementById('viewTitle').innerText = `æœå°‹: "${searchTerm}"`;
        else {
            const c = appData.categories.find(x=>x.id===selMain);
            document.getElementById('viewTitle').innerText = (selMain==='all') ? 'å…¨éƒ¨ç”¢å“' : (c ? c.name : 'æœªçŸ¥');
        }

        appData.categories.forEach(cat => {
            if(!isSearching && selMain!=='all' && cat.id!==selMain) return;
            cat.products.forEach(p => {
                if(isSearching && !p.name.toLowerCase().includes(searchTerm)) return;
                hasData = true;
                const imgHtml = p.img ? `<img src="${p.img}" class="card-img">` : `<span class="no-img">ç„¡åœ–</span>`;
                const codeHtml = p.barcode ? `<div class="barcode-display"><img src="${p.barcode}"></div>` : `<span class="no-barcode"></span>`;
                const costHtml = isInternalMode ? `<div class="cost-badge">æˆæœ¬: $${p.cost||0}</div>` : '';

                html += `
                <div class="neu-flat card">
                    <div class="card-main-area">
                        <div class="card-left-col"><div class="card-img-box">${imgHtml}</div>${codeHtml}</div>
                        <div class="card-info">
                            <div><div class="card-title">${p.name}</div><div class="card-tag">${cat.name}</div>${costHtml}</div>
                            <div class="card-details">è¦æ ¼: ${p.contentWeight}${p.unit} (å«åŒ…: ${p.outerWeight}${p.unit})<br>å°ºå¯¸: ${p.sizeL||0}x${p.sizeW||0}x${p.sizeH||0}cm</div>
                            <div class="card-footer">
                                <div class="card-price">$${p.price}</div>
                                <div class="card-actions"><button class="btn-text" onclick="editProd('${p.id}','${cat.id}')">ç·¨è¼¯</button><button class="btn-text btn-del" onclick="delProd('${p.id}','${cat.id}')">åˆªé™¤</button></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-text btn-toggle" onclick="toggleDesc(this)" style="width:100%; margin-top:10px;">ğŸ“ ç”¢å“ä»‹ç´¹</button>
                    <div class="card-desc-area">${p.desc||'æš«ç„¡ä»‹ç´¹'}</div>
                </div>`;
            });
        });
        list.innerHTML = hasData ? html : `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-sub);">ç„¡è³‡æ–™ (æˆ–æ­£åœ¨è®€å–ä¸­...)</div>`;
    }

    function toggleDesc(btn) {
        const area = btn.nextElementSibling; area.classList.toggle('open');
        btn.classList.toggle('active'); btn.innerText = area.classList.contains('open') ? 'â–² æ”¶èµ·ä»‹ç´¹' : 'ğŸ“ ç”¢å“ä»‹ç´¹';
    }

    // --- Selects & Modals ---
    function renderSelects() {
        const main = document.getElementById('mainCatSelect');
        const curr = main.value;
        let html = `<option value="all">æ‰€æœ‰åˆ†é¡</option>`;
        appData.categories.forEach(c => html += `<option value="${c.id}">${c.name}</option>`);
        main.innerHTML = html; 
        
        // å˜—è©¦ä¿æŒé¸å–ç‹€æ…‹ï¼Œå¦‚æœè©²é¸é …é‚„åœ¨çš„è©±
        if(curr && curr !== 'all') {
             // æª¢æŸ¥ç›®å‰çš„è³‡æ–™è£¡é‚„æœ‰æ²’æœ‰é€™å€‹ ID
             const exists = appData.categories.find(c => c.id === curr);
             main.value = exists ? curr : 'all';
        } else {
             main.value = 'all';
        }
    }
    function filterChange() { document.getElementById('searchInput').value=''; renderProducts(); }
    function openModal(id) { document.getElementById(id).classList.add('show'); if(id==='settingsModal') renderManageList(); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    // --- Category CRUD ---
    function renderManageList() {
        document.getElementById('categoryManageList').innerHTML = appData.categories.map(c => `
            <div class="cat-item"><div class="cat-name">${c.name}</div><div class="cat-actions"><button class="btn-text" onclick="renameCat('${c.id}')">âœ</button><button class="btn-text btn-del" onclick="delCat('${c.id}')">âœ•</button></div></div>
        `).join('');
    }
    function addCategory() { const n = document.getElementById('newMainCat').value; if(n){ appData.categories.push({id:'c'+Date.now(),name:n,products:[]}); document.getElementById('newMainCat').value=''; saveToCloud(appData); } }
    function renameCat(id) { const c = appData.categories.find(x=>x.id===id); const n = prompt("æ–°åç¨±:", c.name); if(n&&n.trim()){ c.name=n.trim(); saveToCloud(appData); } }
    function delCat(id) { if(confirm("åˆªé™¤åˆ†é¡æœƒä¸€ä½µåˆªé™¤ç”¢å“ï¼Œç¢ºå®šï¼Ÿ")){ appData.categories=appData.categories.filter(c=>c.id!==id); saveToCloud(appData); } }
    
    // --- Product CRUD ---
    function openProductModal() {
        ['pId','pName','pOutW','pInW','pPrice','pCost','sizeL','sizeW','sizeH','pDesc'].forEach(k=>document.getElementById(k).value='');
        document.getElementById('volDisplay').innerText='0'; resetPreview('prevImg'); resetPreview('prevCode');
        
        // Hide/Show Cost based on Mode
        document.getElementById('costInputGroup').style.display = isInternalMode ? 'block' : 'none';

        const catSel = document.getElementById('pCat'); catSel.innerHTML='<option value="">è«‹é¸æ“‡</option>'+appData.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        const currMain = document.getElementById('mainCatSelect').value; if(currMain!=='all') catSel.value=currMain;
        openModal('productModal');
    }
    function editProd(pid, cid) {
        openProductModal();
        const c = appData.categories.find(x=>x.id===cid), p = c.products.find(x=>x.id===pid);
        document.getElementById('pId').value=pid; document.getElementById('pCat').value=cid;
        document.getElementById('pName').value=p.name; document.getElementById('pOutW').value=p.outerWeight; document.getElementById('pInW').value=p.contentWeight;
        document.getElementById('pUnit').value=p.unit; document.getElementById('pPrice').value=p.price; document.getElementById('pCost').value=p.cost||'';
        document.getElementById('sizeL').value=p.sizeL; document.getElementById('sizeW').value=p.sizeW; document.getElementById('sizeH').value=p.sizeH;
        document.getElementById('volDisplay').innerText=p.volume||0; document.getElementById('pDesc').value=p.desc||'';
        if(p.img) setPreview('prevImg', p.img); if(p.barcode) setPreview('prevCode', p.barcode);
    }
    function saveProduct() {
        const cid = document.getElementById('pCat').value, name = document.getElementById('pName').value;
        if(!cid||!name) return alert('åˆ†é¡èˆ‡åç¨±å¿…å¡«');
        const pid = document.getElementById('pId').value;
        const dat = { id: pid||'p'+Date.now(), name, outerWeight:document.getElementById('pOutW').value, contentWeight:document.getElementById('pInW').value, unit:document.getElementById('pUnit').value, price:document.getElementById('pPrice').value, cost:document.getElementById('pCost').value, sizeL:document.getElementById('sizeL').value, sizeW:document.getElementById('sizeW').value, sizeH:document.getElementById('sizeH').value, volume:document.getElementById('volDisplay').innerText, desc:document.getElementById('pDesc').value, img:document.getElementById('prevImg').dataset.val||'', barcode:document.getElementById('prevCode').dataset.val||'' };
        
        // åˆªé™¤èˆŠçš„ (å¦‚æœæ˜¯ç·¨è¼¯)
        if(pid) appData.categories.forEach(c=>c.products=c.products.filter(x=>x.id!==pid));
        
        // åŠ å…¥æ–°çš„
        const cat = appData.categories.find(c=>c.id===cid);
        if (cat) {
            cat.products.push(dat);
            saveToCloud(appData); // å„²å­˜åˆ°é›²ç«¯
            closeModal('productModal');
        } else {
            alert("åˆ†é¡ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°æ•´ç†");
        }
    }
    function delProd(pid, cid) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")){ const c=appData.categories.find(x=>x.id===cid); c.products=c.products.filter(x=>x.id!==pid); saveToCloud(appData); } }

    // --- Helpers ---
    function calcVol() { const l=document.getElementById('sizeL').value||0, w=document.getElementById('sizeW').value||0, h=document.getElementById('sizeH').value||0; document.getElementById('volDisplay').innerText=l*w*h; }
    function preview(i, d) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>setPreview(d, e.target.result); r.readAsDataURL(i.files[0]); } }
    function setPreview(d, s) { const el=document.getElementById(d); el.innerHTML=`<img src="${s}">`; el.dataset.val=s; }
    function resetPreview(d) { const el=document.getElementById(d); el.innerHTML=`<span>ä¸Šå‚³</span>`; delete el.dataset.val; }
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData)); a.download='data.json'; document.body.appendChild(a); a.click(); a.remove(); }
    
    // åŒ¯å…¥è³‡æ–™ä¹Ÿè¦æ”¹æˆå„²å­˜åˆ°é›²ç«¯
    function importData(i) { 
        if(i.files[0]){ 
            const r=new FileReader(); 
            r.onload=e=>{ 
                try{ 
                    const newData = JSON.parse(e.target.result); 
                    saveToCloud(newData); 
                    alert("åŒ¯å…¥ä¸¦åŒæ­¥æˆåŠŸï¼"); 
                }catch(z){
                    alert("æ ¼å¼éŒ¯èª¤");
                }
            }; 
            r.readAsText(i.files[0]); 
        } 
    }
    
    async function generatePDF() {
        const h = document.getElementById('pdfHead');
        h.innerHTML = isInternalMode ? `<th>åç¨±</th><th>åˆ†é¡</th><th>è¦æ ¼</th><th>åƒ¹æ ¼</th><th>æˆæœ¬</th><th>å°ºå¯¸</th><th>æ¢ç¢¼</th>` : `<th>åç¨±</th><th>åˆ†é¡</th><th>è¦æ ¼</th><th>åƒ¹æ ¼</th><th>å°ºå¯¸</th><th>æ¢ç¢¼</th>`;
        const b = document.getElementById('pdfTbody'); b.innerHTML='';
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
        const term = document.getElementById('searchInput').value.trim().toLowerCase();
        const main = document.getElementById('mainCatSelect').value;
        appData.categories.forEach(c => {
            if(main!=='all' && c.id!==main) return;
            c.products.forEach(p => {
                if(term && !p.name.toLowerCase().includes(term)) return;
                const costTd = isInternalMode ? `<td>$${p.cost||0}</td>` : '';
                b.innerHTML += `<tr><td>${p.name}</td><td>${c.name}</td><td>${p.contentWeight}${p.unit}</td><td>${p.price}</td>${costTd}<td>${p.sizeL||0}x${p.sizeW||0}x${p.sizeH||0}</td><td>${p.barcode?`<img src="${p.barcode}" height="30">`:''}</td></tr>`;
            });
        });
        const el = document.getElementById('pdf-hidden'); el.style.top='0'; el.style.left='0'; el.style.background='#fff'; el.style.zIndex='200';
        try { const cvs = await html2canvas(el, {scale:2}); const pdf = new window.jspdf.jsPDF(); pdf.addImage(cvs.toDataURL('image/jpeg'),'JPEG',0,0,pdf.internal.pageSize.getWidth(), (cvs.height*pdf.internal.pageSize.getWidth())/cvs.width); pdf.save('list.pdf'); } catch(e){alert('Error');} finally {el.style.top='-9999px';}
    }
    
    // åˆå§‹è¼‰å…¥ç­‰å¾… Firebase onSnapshot è§¸ç™¼ï¼Œä¸éœ€è¦æ‰‹å‹•å‘¼å« init()
    // init(); 
</script>
</body>
</html>
